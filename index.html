<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHEM.OS_ULTIMATE_v13.0</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <style>
        :root {
            --os-bg: #008080;
            --toxic-green: #39ff14;
            --taskbar-bg: #c0c0c0;
            --win-title: #000080;
            --win-text: #ffffff;
        }

        body {
            background-color: var(--os-bg);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-family: "Pixelated MS Sans Serif", Arial, sans-serif;
            overflow: hidden;
            transition: filter 0.3s, transform 0.3s;
        }

        /* Trolling/Visual Effects */
        body.inverted { filter: invert(1); }
        body.shaking { animation: shake 0.2s infinite; }
        body.flipped { transform: scaleX(-1); }
        body.grayscale { filter: grayscale(1); }
        body.crashed { background: #0000aa !important; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-2px, -1px) rotate(1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        @keyframes admin-glow {
            0% { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
            33% { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
            66% { color: #0000ff; text-shadow: 0 0 10px #0000ff; }
            100% { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
        }
        .hacker-aura { animation: admin-glow 1.5s infinite linear; font-weight: bold; }
        .glitch-text { text-decoration: line-through; font-style: italic; letter-spacing: 2px; }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: var(--toxic-green); z-index: 100000;
            display: flex; flex-direction: column; padding: 40px; font-family: monospace;
        }

        .desktop-area { 
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 35px); 
            padding: 20px; display: flex; flex-direction: column; flex-wrap: wrap; gap: 20px; align-content: flex-start;
        }

        .d-icon { 
            width: 85px; text-align: center; cursor: pointer; color: #fff; 
            text-shadow: 1px 1px 2px #000; font-size: 11px; user-select: none;
        }
        .d-icon img { width: 32px; height: 32px; margin-bottom: 5px; pointer-events: none; }

        .window { position: absolute; min-width: 250px; display: none; box-shadow: 4px 4px 10px rgba(0,0,0,0.4); z-index: 100; }
        .title-bar { cursor: move; }

        #taskbar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35px;
            background: var(--taskbar-bg); border-top: 2px solid #fff;
            display: flex; align-items: center; padding: 2px 5px; z-index: 90000;
        }

        #chat-content { height: 300px; background: #fff; color: #000; border: 2px inset; overflow-y: auto; padding: 8px; }
        .chat-msg { margin-bottom: 8px; font-size: 12px; display: flex; gap: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .avatar-sm { width: 32px; height: 32px; border: 1px solid #000; object-fit: cover; flex-shrink: 0; }
        
        #shop-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; height: 250px; overflow-y: auto; padding: 5px; background: #fff; border: 2px inset; }
        .item-card { border: 1px solid #777; padding: 5px; text-align: center; background: #eee; font-size: 11px; }
        .item-card img { width: 60px; height: 60px; object-fit: contain; background: #fff; border: 1px solid #000; }

        #start-menu {
            position: fixed; bottom: 35px; left: 0; width: 220px;
            background: var(--taskbar-bg); border: 2px solid #fff;
            z-index: 99999; display: none; box-shadow: 2px -2px 10px rgba(0,0,0,0.5);
        }
        .start-item { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .start-item:hover { background: var(--win-title); color: #fff; }

        .smiley-pop { position: absolute; font-size: 40px; pointer-events: none; animation: popUp 1s ease-out forwards; z-index: 10000; }
        @keyframes popUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-100px) scale(2); } }

        #mine-grid { display: grid; grid-template-columns: repeat(10, 22px); background: #bdbdbd; border: 2px inset; }
        .mine-cell { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; background: #c0c0c0; border: 2px outset #fff; user-select: none; }
        
        .flex-msg-item { border: 2px solid gold; padding: 5px; background: #fff; display: inline-block; text-align: center; margin-top: 5px; box-shadow: 0 0 5px gold; }
        .bsod { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0000aa; color: #fff; padding: 40px; font-family: monospace; z-index: 2000000; }
    </style>
</head>
<body onclick="window.closeStart()">

<div id="bsod-screen" class="bsod">
    <h1 style="background:#fff; color:#0000aa; display:inline-block; padding:0 10px;">KHEM.OS</h1>
    <p>A problem has been detected and KHEM.OS has been shut down to prevent damage to your virtual sanity.</p>
    <p>ADMIN_FORCED_CRASH_0x0000DEAD</p>
    <p>Press RESTART to attempt recovery.</p>
    <button onclick="location.reload()">RESTART</button>
</div>

<div id="loading-screen">
    <div id="bios-text"></div>
    <div style="width: 240px; height: 12px; border: 1px solid #555; margin-top: 20px; padding: 1px;">
        <div id="boot-progress" style="height: 100%; background: var(--toxic-green); width: 0%;"></div>
    </div>
</div>

<div class="desktop-area">
    <div class="d-icon" onclick="window.openWin('chat-win')"><img src="https://win98icons.alexmeub.com/icons/png/msie2-2.png"><div>Network_Chat</div></div>
    <div class="d-icon" onclick="window.openWin('shop-win')"><img src="https://win98icons.alexmeub.com/icons/png/envelope_closed-0.png"><div>Marketplace</div></div>
    <div class="d-icon" onclick="window.openWin('inventory-win')"><img src="https://win98icons.alexmeub.com/icons/png/briefcase-0.png"><div>My_Stuff</div></div>
    <div class="d-icon" onclick="window.openWin('casino-win')"><img src="https://win98icons.alexmeub.com/icons/png/joystick-0.png"><div>Casino</div></div>
    <div class="d-icon" onclick="window.openWin('cam-win')"><img src="https://win98icons.alexmeub.com/icons/png/camera-0.png"><div>Media_Hub</div></div>
    <div class="d-icon" onclick="window.openWin('mine-win')"><img src="https://win98icons.alexmeub.com/icons/png/minesweeper-0.png"><div>Mines</div></div>
</div>

<!-- PROFILE SETUP -->
<div class="window" id="profile-win" style="width: 320px; top: 20%; left: 30%; z-index: 100000;">
    <div class="title-bar"><div class="title-bar-text">Identity Setup</div></div>
    <div class="window-body">
        <div style="display: flex; gap: 15px;">
            <div style="text-align:center">
                <img id="pfp-preview" style="width:64px; height:64px; border:2px inset; object-fit:cover;" src="https://win98icons.alexmeub.com/icons/png/user_world-0.png">
                <button onclick="document.getElementById('pfp-input').click()" style="width:100%; margin-top:5px;">Photo</button>
                <input type="file" id="pfp-input" accept="image/*" style="display:none" onchange="window.handlePfp(this)">
            </div>
            <div style="flex:1">
                <div class="field-row-stacked">
                    <label>Network Handle:</label>
                    <input id="prof-user" type="text" maxlength="15" style="width:100%">
                </div>
                <div class="field-row-stacked" style="margin-top:8px">
                    <label>Handle Color:</label>
                    <input id="prof-color" type="color" value="#39ff14" style="width:100%">
                </div>
            </div>
        </div>
        <button style="width: 100%; margin-top: 15px; font-weight: bold; height: 30px;" onclick="window.saveProfile()">SYNC & CONNECT</button>
    </div>
</div>

<!-- SHOP WINDOW -->
<div class="window" id="shop-win" style="width: 400px; top: 50px; left: 450px;">
    <div class="title-bar"><div class="title-bar-text">Marketplace</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('shop-win')"></button></div></div>
    <div class="window-body">
        <div id="shop-list"></div>
        <hr>
        <p><b>List New Item (Max 800MB):</b></p>
        <div class="field-row">
            <input type="text" id="new-item-name" placeholder="Item Name" style="flex:1">
            <input type="number" id="new-item-price" placeholder="Price" style="width:60px">
            <button onclick="document.getElementById('item-upload').click()">Img/File</button>
            <input type="file" id="item-upload" hidden onchange="window.listItem(this)">
        </div>
    </div>
</div>

<!-- INVENTORY WINDOW -->
<div class="window" id="inventory-win" style="width: 320px; top: 100px; left: 870px;">
    <div class="title-bar"><div class="title-bar-text">My Inventory</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('inventory-win')"></button></div></div>
    <div class="window-body">
        <div id="inv-list" style="height:250px; overflow-y:auto; background:#fff; border:2px inset; padding:5px;"></div>
    </div>
</div>

<!-- CHAT WINDOW -->
<div class="window" id="chat-win" style="width: 450px; top: 40px; left: 50px;">
    <div class="title-bar"><div class="title-bar-text">KHEM_NET Chat</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('chat-win')"></button></div></div>
    <div class="window-body">
        <div id="chat-content"></div>
        <div class="field-row" style="margin-top: 10px;">
            <button onclick="document.getElementById('chat-img-input').click()" title="Send File (800MB)">üìÅ</button>
            <input type="file" id="chat-img-input" style="display:none" onchange="window.sendImage(this)">
            <input id="chat-input" type="text" placeholder="Type message..." style="flex:1" onkeydown="if(event.key==='Enter') window.sendChat()">
            <button onclick="window.sendChat()">Send</button>
        </div>
    </div>
</div>

<!-- MEDIA HUB (CAMERA) -->
<div class="window" id="cam-win" style="width: 320px; top: 100px; left: 650px;">
    <div class="title-bar"><div class="title-bar-text">Media Hub</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('cam-win')"></button></div></div>
    <div class="window-body">
        <video id="camera-preview" autoplay playsinline style="width:100%; background:#000; transform: scaleX(-1);"></video>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button onclick="window.startCam()" style="flex:1">Start</button>
            <button id="snap-btn" onclick="window.takeSnap()" style="flex:1" disabled>Capture</button>
        </div>
        <canvas id="cam-canvas" style="display:none"></canvas>
    </div>
</div>

<!-- MINESWEEPER -->
<div class="window" id="mine-win" style="top: 150px; left: 850px;">
    <div class="title-bar"><div class="title-bar-text">Mines</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('mine-win')"></button></div></div>
    <div class="window-body">
        <div id="mine-grid"></div>
        <button onclick="window.initMines()" style="width: 100%; margin-top: 5px;">Reset</button>
    </div>
</div>

<!-- ADMIN CONSOLE -->
<div class="window" id="admin-win" style="width: 350px; top: 30%; left: 35%;">
    <div class="title-bar" style="background:linear-gradient(90deg, #800, #000)!important;">
        <div class="title-bar-text">ADMIN_COMMAND_CENTER_v13.0</div>
        <div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('admin-win')"></button></div>
    </div>
    <div class="window-body" style="background:#111; color:lime; font-family:monospace; padding:10px; font-size: 11px;">
        <p style="border-bottom:1px solid #333">MODERATION</p>
        <div class="field-row">
            <input type="checkbox" id="intercept-toggle"> <label for="intercept-toggle">INTERCEPT_MSG</label>
            <button onclick="window.troll('mute')">SILENCE_ALL</button>
        </div>
        
        <div id="intercept-box" style="display:none; margin-top:5px; border:1px solid red; padding:5px;">
            <p id="pending-msg-info" style="color:yellow;"></p>
            <input type="text" id="intercept-edit" style="width:100%; background:#222; color:#fff;">
            <button onclick="window.releaseIntercept()">RELEASE</button>
        </div>

        <p style="border-bottom:1px solid #333; margin-top:10px;">IDENTITY</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button onclick="window.toggleAdminStyle('aura')">AURA</button>
            <button onclick="window.toggleAdminStyle('glitch')">GLITCH</button>
            <input type="color" id="admin-color-picker" onchange="window.updateAdminColor(this.value)" style="width:100%">
        </div>

        <p style="border-bottom:1px solid #333; margin-top:10px;">GLOBAL OVERRIDE</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button onclick="window.troll('shake')">SHAKE</button>
            <button onclick="window.troll('invert')">INVERT</button>
            <button onclick="window.troll('flip')">FLIP</button>
            <button onclick="window.troll('grayscale')">GRAY</button>
            <button onclick="window.troll('crash')" style="color:red; font-weight:bold;">CRASH_ALL</button>
            <button onclick="window.troll('rainbow')" style="color:cyan;">RAINBOW_MODE</button>
        </div>

        <p style="border-bottom:1px solid #333; margin-top:10px;">ECONOMY_HACK</p>
        <div class="field-row">
            <input type="text" id="target-user" placeholder="Name or *" style="width:80px; background:#000; color:lime;">
            <input type="number" id="gift-amt" placeholder="Amt" style="width:50px; background:#000; color:lime;">
            <button onclick="window.adminGift()">GIVE_CASH</button>
        </div>
        <button onclick="window.adminItemAction('remove')" style="width:100%; color:orange; margin-top:5px;">STEAL_INVENTORY</button>
        <button onclick="window.adminClearAll()" style="width:100%; color:red; margin-top:5px;">WIPE_MARKET</button>
    </div>
</div>

<!-- CASINO -->
<div class="window" id="casino-win" style="width: 200px; top: 400px; left: 500px;">
    <div class="title-bar"><div class="title-bar-text">Casino</div></div>
    <div class="window-body">
        <div style="background:#000; color:gold; text-align:center; padding:10px; border:2px inset; font-family:monospace; margin-bottom: 5px;">$<span id="balance">5000</span></div>
        <button onclick="window.spin()" style="width:100%">SPIN ($50)</button>
    </div>
</div>

<div id="start-menu">
    <div style="background: var(--win-title); color: #fff; padding: 5px 10px; font-weight: bold;">KHEM.OS v13.0</div>
    <div class="start-item" onclick="window.authAdmin()">üîë Admin Access</div>
    <div class="start-item" onclick="window.openWin('profile-win')">üë§ Profile Setup</div>
    <div class="start-item" onclick="window.openWin('shop-win')">üõçÔ∏è Marketplace</div>
    <hr>
    <div class="start-item" onclick="location.reload()">üîÑ Restart</div>
</div>

<div id="taskbar">
    <button onclick="window.toggleStart(event)">Start</button>
    <div style="margin-left:auto; border:2px inset; padding:2px 10px;" id="clock">00:00</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, onChildAdded, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = {
        apiKey: "AIzaSyD7THaNrq5OdU_b9GuU82AQsnyy_Eewey4",
        authDomain: "chatroon-4ded8.firebaseapp.com",
        databaseURL: "https://chatroon-4ded8-default-rtdb.firebaseio.com",
        projectId: "chatroon-4ded8",
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    const dbPath = "khem_os_v13_0";

    let myData = {
        name: localStorage.getItem('khem_name') || "",
        color: localStorage.getItem('khem_color') || "#39ff14",
        pfp: localStorage.getItem('khem_pfp') || "https://win98icons.alexmeub.com/icons/png/user_world-0.png",
        bal: parseInt(localStorage.getItem('khem_bal')) || 5000,
        isAdmin: false,
        aura: false,
        glitch: false,
        isMuted: false,
        inventory: JSON.parse(localStorage.getItem('khem_inv')) || []
    };

    // --- PROFANITY FILTER ---
    const blacklist = ["fuck", "shit", "nigger", "faggot", "cunt", "retard", "bitch", "slut", "whore", "nigga"];
    function sanitize(text) {
        if (!text) return "";
        const lower = text.toLowerCase();
        for (let word of blacklist) {
            if (lower.includes(word)) return "Im A Bad Person i tried to type something bad";
        }
        return text;
    }

    // Window Dragging
    let draggedWin = null, offset = { x: 0, y: 0 };
    document.addEventListener('mousedown', e => {
        const bar = e.target.closest('.title-bar');
        if (bar) {
            draggedWin = bar.parentElement;
            draggedWin.style.zIndex = Date.now();
            offset.x = e.clientX - draggedWin.offsetLeft;
            offset.y = e.clientY - draggedWin.offsetTop;
        }
    });
    document.addEventListener('mousemove', e => {
        if (!draggedWin) return;
        draggedWin.style.left = (e.clientX - offset.x) + "px";
        draggedWin.style.top = (e.clientY - offset.y) + "px";
    });
    document.addEventListener('mouseup', () => draggedWin = null);

    // Boot Sequence
    const bios = document.getElementById('bios-text');
    const lines = ["MODEM_SYNC_OK", "MEM_V13.0_LOAD", "CAM_DRIVERS_INIT", "FILE_LIMIT_800MB_SET", "PROF_FILTER_ACTIVE"];
    lines.forEach((l, i) => {
        setTimeout(() => {
            bios.innerHTML += `<div style="color:lime">> ${l}</div>`;
            document.getElementById('boot-progress').style.width = ((i+1) * 20) + "%";
        }, i * 250);
    });
    setTimeout(() => {
        document.getElementById('loading-screen').style.display='none';
        if (!myData.name) window.openWin('profile-win');
        else {
            document.getElementById('prof-user').value = myData.name;
            document.getElementById('prof-color').value = myData.color;
            document.getElementById('pfp-preview').src = myData.pfp;
            document.getElementById('balance').innerText = myData.bal;
            window.openWin('chat-win');
        }
    }, 1500);

    // Window Controls
    window.openWin = id => document.getElementById(id).style.display = 'block';
    window.closeWin = id => document.getElementById(id).style.display = 'none';
    window.toggleStart = e => { e.stopPropagation(); const m = document.getElementById('start-menu'); m.style.display = m.style.display==='block'?'none':'block'; };
    window.closeStart = () => document.getElementById('start-menu').style.display = 'none';
    
    window.authAdmin = () => { if(prompt("ACCESS:")==="pine") { myData.isAdmin=true; window.openWin('admin-win'); } };

    window.handlePfp = input => {
        const reader = new FileReader();
        reader.onload = e => { myData.pfp = e.target.result; document.getElementById('pfp-preview').src = e.target.result; };
        reader.readAsDataURL(input.files[0]);
    };

    window.saveProfile = () => {
        const n = document.getElementById('prof-user').value;
        if (!n) return;
        myData.name = sanitize(n);
        myData.color = document.getElementById('prof-color').value;
        localStorage.setItem('khem_name', myData.name);
        localStorage.setItem('khem_color', myData.color);
        localStorage.setItem('khem_pfp', myData.pfp);
        window.closeWin('profile-win');
        window.openWin('chat-win');
    };

    // Chat logic
    window.sendChat = () => {
        if(myData.isMuted) return alert("You have been silenced by an Administrator.");
        const inp = document.getElementById('chat-input');
        if(!inp.value) return;
        const rawMsg = sanitize(inp.value);
        if(rawMsg.toLowerCase().includes("smile")) window.spawnSmiley();

        onValue(ref(db, `${dbPath}/config/intercept`), snap => {
            if(snap.val() && !myData.isAdmin) {
                push(ref(db, `${dbPath}/intercept_queue`), { from: myData.name, msg: rawMsg, data: { ...myData, bal: null, inventory: null } });
                inp.value = "";
                alert("Intercepted by Moderator...");
            } else {
                window.postMsg(rawMsg, myData);
                inp.value = "";
            }
        }, { onlyOnce: true });
    };

    window.postMsg = (msg, sender, type='text', extra={}) => {
        push(ref(db, `${dbPath}/chat`), { ...sender, msg, type, ...extra, time: Date.now() });
    };

    window.sendImage = (input) => {
        if(myData.isMuted) return;
        const file = input.files[0];
        // 800MB check (800 * 1024 * 1024 bytes)
        if (file.size > 800 * 1024 * 1024) {
            alert("File too large! Max 800MB.");
            return;
        }
        const reader = new FileReader();
        reader.onload = e => window.postMsg(e.target.result, myData, 'image');
        reader.readAsDataURL(file);
    };

    window.spawnSmiley = () => {
        const s = document.createElement('div');
        s.className = 'smiley-pop';
        s.innerText = ['üòä','üòé','üòÇ','ü§°','üëΩ'][Math.floor(Math.random()*5)];
        s.style.left = Math.random() * 80 + 10 + "%";
        s.style.top = "80%";
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 1000);
    };

    onValue(ref(db, `${dbPath}/chat`), snap => {
        const box = document.getElementById('chat-content');
        box.innerHTML = "";
        snap.forEach(m => {
            const d = m.val();
            let style = "";
            if(d.aura) style += " hacker-aura";
            if(d.glitch) style += " glitch-text";
            let content = `<span>${d.msg}</span>`;
            if(d.type === 'image') {
                if(d.msg.startsWith('data:image/')) {
                    content = `<img src="${d.msg}" style="max-width:200px; border:1px solid #000;">`;
                } else {
                    content = `<div style="padding:5px; border:1px dashed #777;">Uploaded File (Binary Blob)</div>`;
                }
            }
            if(d.type === 'flex') {
                content = `<div class="flex-msg-item">
                    <b>FLEX: ${d.itemName}</b><br>
                    <img src="${d.msg}" style="width:60px; margin:5px 0;"><br>
                    <span style="color:green; font-weight:bold;">Paid: $${d.paidPrice}</span>
                </div>`;
            }
            
            box.innerHTML += `<div class="chat-msg"><img src="${d.pfp}" class="avatar-sm"><div><b style="color:${d.color}" class="${style}">${d.name}</b>: ${content}</div></div>`;
        });
        box.scrollTop = box.scrollHeight;
    });

    // Marketplace
    window.listItem = (input) => {
        const file = input.files[0];
        if (file.size > 800 * 1024 * 1024) return alert("File too large (800MB max)");
        
        const nameInput = document.getElementById('new-item-name');
        const priceInput = document.getElementById('new-item-price');
        const name = nameInput.value;
        const price = parseInt(priceInput.value);
        if(!name || !price) return;
        const reader = new FileReader();
        reader.onload = e => {
            push(ref(db, `${dbPath}/market`), { name, price, img: e.target.result, seller: myData.name });
            nameInput.value = "";
            priceInput.value = "";
        };
        reader.readAsDataURL(file);
    };

    onValue(ref(db, `${dbPath}/market`), snap => {
        const list = document.getElementById('shop-list');
        list.innerHTML = "";
        snap.forEach(i => {
            const item = i.val();
            const isMine = item.seller === myData.name;
            list.innerHTML += `<div class="item-card">
                <img src="${item.img}"><br>
                <b>${item.name}</b><br>
                <span style="color:green">$${item.price}</span><br>
                ${isMine 
                    ? `<button onclick="window.unlistItem('${i.key}')" style="background: #ffaaaa">Remove</button>` 
                    : `<button onclick="window.buyItem('${i.key}', ${item.price})">Buy</button>`
                }
            </div>`;
        });
    });

    window.unlistItem = (id) => {
        if(confirm("Remove this listing?")) {
            remove(ref(db, `${dbPath}/market/${id}`));
        }
    };

    window.buyItem = async (id, price) => {
        if(myData.bal < price) return alert("Insufficient funds.");
        
        const itemSnap = await get(ref(db, `${dbPath}/market/${id}`));
        const item = itemSnap.val();
        
        if(!item) {
            alert("Item sold or removed!");
            return;
        }

        await remove(ref(db, `${dbPath}/market/${id}`));
        
        myData.bal -= price;
        myData.inventory.push({ name: item.name, img: item.img, boughtAt: price });
        
        localStorage.setItem('khem_bal', myData.bal);
        localStorage.setItem('khem_inv', JSON.stringify(myData.inventory));
        document.getElementById('balance').innerText = myData.bal;
        window.updateInv();
        alert(`Successfully acquired ${item.name}!`);
    };

    window.updateInv = () => {
        const inv = document.getElementById('inv-list');
        inv.innerHTML = "";
        myData.inventory.forEach((it, idx) => {
            inv.innerHTML += `<div style="display:flex; align-items:center; gap:5px; border-bottom:1px solid #ccc; padding: 3px;">
                <img src="${it.img}" style="width:24px; height:24px; object-fit: contain;">
                <span style="flex:1; font-size:10px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${it.name}</span>
                <button onclick="window.flexItem(${idx})" title="Flex original price">Flex</button>
                <button onclick="window.resellItem(${idx})" style="background: #ccffcc" title="Put back on market">Resell</button>
            </div>`;
        });
    };
    window.updateInv();

    window.resellItem = (idx) => {
        const it = myData.inventory[idx];
        const newPrice = prompt(`Resell "${it.name}" for how much?`, it.boughtAt || 100);
        if(!newPrice || isNaN(newPrice)) return;

        push(ref(db, `${dbPath}/market`), { 
            name: it.name, 
            price: parseInt(newPrice), 
            img: it.img, 
            seller: myData.name 
        });

        myData.inventory.splice(idx, 1);
        localStorage.setItem('khem_inv', JSON.stringify(myData.inventory));
        window.updateInv();
        alert("Relisted!");
    };

    window.flexItem = (idx) => {
        const it = myData.inventory[idx];
        // Now passing the 'boughtAt' price in the flex data
        push(ref(db, `${dbPath}/chat`), { 
            ...myData, 
            msg: it.img, 
            itemName: it.name, 
            paidPrice: it.boughtAt || "Unknown",
            type: 'flex' 
        });
    };

    // Camera
    let stream;
    window.startCam = async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('camera-preview').srcObject = stream;
            document.getElementById('snap-btn').disabled = false;
        } catch(e) { alert("Cam Fail"); }
    };
    window.takeSnap = () => {
        const video = document.getElementById('camera-preview');
        const canvas = document.getElementById('cam-canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.translate(canvas.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0);
        window.postMsg(canvas.toDataURL('image/jpeg', 0.7), myData, 'image');
    };

    // Intercept
    let pending = null;
    document.getElementById('intercept-toggle').onchange = e => set(ref(db, `${dbPath}/config/intercept`), e.target.checked);
    onValue(ref(db, `${dbPath}/intercept_queue`), snap => {
        if(!myData.isAdmin) return;
        const box = document.getElementById('intercept-box');
        if(snap.size > 0) {
            box.style.display = 'block';
            snap.forEach(m => { pending = { key: m.key, ...m.val() }; document.getElementById('pending-msg-info').innerText = `Review: ${pending.msg}`; document.getElementById('intercept-edit').value = pending.msg; return true; });
        } else box.style.display = 'none';
    });
    window.releaseIntercept = () => {
        window.postMsg(`[MOD] ${document.getElementById('intercept-edit').value}`, pending.data);
        remove(ref(db, `${dbPath}/intercept_queue/${pending.key}`));
    };

    // Trolls & Admin Commands
    window.troll = type => push(ref(db, `${dbPath}/trolls`), { type, time: Date.now() });
    onChildAdded(ref(db, `${dbPath}/trolls`), snap => {
        const t = snap.val(); if(t.time < Date.now() - 5000) return;
        
        if(t.type === 'shake') { document.body.classList.add('shaking'); setTimeout(()=>document.body.classList.remove('shaking'), 2000); }
        else if(t.type === 'invert') document.body.classList.toggle('inverted');
        else if(t.type === 'flip') document.body.classList.toggle('flipped');
        else if(t.type === 'grayscale') document.body.classList.toggle('grayscale');
        else if(t.type === 'mute') { myData.isMuted = true; setTimeout(()=>myData.isMuted=false, 10000); alert("Global Silence initiated by Admin."); }
        else if(t.type === 'crash') { document.getElementById('bsod-screen').style.display = 'block'; }
        else if(t.type === 'rainbow') { 
            let i = 0; 
            const int = setInterval(()=>{
                document.body.style.backgroundColor = `hsl(${i}, 50%, 50%)`;
                i+=10; if(i>360) clearInterval(int);
            }, 50);
        }
        else if(t.type === 'give_cash' && (t.target === myData.name || t.target === "*")) { 
            myData.bal += parseInt(t.val); 
            document.getElementById('balance').innerText = myData.bal; 
            localStorage.setItem('khem_bal', myData.bal); 
        }
        else if(t.type === 'steal' && (t.target === myData.name || t.target === "*")) { 
            myData.inventory = []; 
            localStorage.setItem('khem_inv', "[]"); 
            window.updateInv(); 
            alert("AN ADMIN STOLE ALL YOUR ITEMS!"); 
        }
    });

    window.adminGift = () => push(ref(db, `${dbPath}/trolls`), { type: 'give_cash', target: document.getElementById('target-user').value, val: document.getElementById('gift-amt').value, time: Date.now() });
    window.adminItemAction = (type) => push(ref(db, `${dbPath}/trolls`), { type: 'steal', target: document.getElementById('target-user').value, time: Date.now() });
    window.toggleAdminStyle = type => { myData[type] = !myData[type]; alert(type + " ENABLED"); };
    window.updateAdminColor = val => { myData.color = val; localStorage.setItem('khem_color', val); };
    window.adminClearAll = () => remove(ref(db, `${dbPath}/market`));

    // Casino
    window.spin = () => {
        if(myData.bal < 50) return; myData.bal -= 50;
        if(Math.random() > 0.95) { 
            myData.bal += 5000; 
            alert("JACKPOT!!! $5000"); 
        } else if (Math.random() > 0.8) {
            myData.bal += 200;
            alert("WIN $200");
        }
        document.getElementById('balance').innerText = myData.bal;
        localStorage.setItem('khem_bal', myData.bal);
    };

    // Mines
    window.initMines = () => {
        const g = document.getElementById('mine-grid'); g.innerHTML = "";
        for(let i=0; i<100; i++) {
            const c = document.createElement('div'); c.className='mine-cell';
            c.onclick = () => { 
                const bomb = Math.random() < 0.20; 
                c.innerText = bomb ? 'üí£' : 'üö©'; 
                c.style.background = bomb ? 'red' : '#eee';
                if(bomb) { 
                    document.body.classList.add('shaking'); 
                    setTimeout(()=>document.body.classList.remove('shaking'), 500); 
                }
            };
            g.appendChild(c);
        }
    };
    window.initMines();

    setInterval(() => {
        const d = new Date();
        document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
    }, 1000);
</script>
</body>
</html>
