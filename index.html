<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>~*~ KHEM.OS_v6.1_PATCHED ~*~</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --toxic-green: #39ff14;
            --toxic-red: #ff3300;
            --shake-x: 0px;
            --shake-y: 0px;
        }

        body {
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-family: "Pixelated MS Sans Serif", Arial, sans-serif;
            overflow: hidden;
            background-image: radial-gradient(circle, #222 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ccc;
            transform: translate(var(--shake-x), var(--shake-y));
        }

        /* --- CRT OVERLAY --- */
        #scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 2px 100%;
            z-index: 9998; pointer-events: none;
        }

        /* --- WINDOWS --- */
        .window { 
            position: absolute; 
            z-index: 10; 
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5); 
            min-width: 200px;
        }
        .title-bar { cursor: grab; user-select: none; }
        .title-bar:active { cursor: grabbing; }

        /* --- CHAT --- */
        .main-window { width: 500px; top: 50px; left: 50px; }
        #chat-content { 
            height: 280px; 
            background: #050505; 
            color: var(--toxic-green); 
            border: 2px inset #444; 
            overflow-y: scroll; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 12px;
        }
        .message-entry { margin-bottom: 8px; border-bottom: 1px solid #1a1a1a; padding-bottom: 4px; }
        .pfp-icon { width: 28px; height: 28px; border: 1px solid var(--toxic-green); vertical-align: middle; margin-right: 5px; }

        /* --- MP3 PLAYER --- */
        #mp3-window { width: 350px; top: 100px; left: 600px; display: none; }
        .visualizer-container {
            height: 100px; background: #000; border: 2px inset #555;
            margin-bottom: 10px; display: flex; align-items: flex-end;
            gap: 2px; padding: 0 5px; overflow: hidden;
        }
        .bar { background: var(--toxic-green); flex-grow: 1; min-width: 2px; }

        /* --- DESKTOP --- */
        .desktop-icons { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 25px; align-items: center; }
        .icon { text-align: center; width: 80px; cursor: pointer; color: white; text-shadow: 2px 2px 2px black; font-size: 11px; user-select: none; }
        .icon img { width: 32px; filter: drop-shadow(0 0 5px var(--toxic-green)); pointer-events: none; }
        .icon:hover { background: rgba(57, 255, 20, 0.2); outline: 1px dotted var(--toxic-green); }

        /* --- SPLASH --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: var(--toxic-red); font-family: monospace;
        }

        /* --- ADMIN PANEL --- */
        #admin-panel { width: 320px; top: 400px; left: 50px; display: none; }

        .glitch-active { animation: glitch 0.15s infinite; }
        @keyframes glitch {
            0% { transform: translate(2px, -2px); filter: hue-rotate(90deg); }
            50% { transform: translate(-2px, 2px); filter: invert(1); }
            100% { transform: translate(1px, 1px); filter: hue-rotate(0deg); }
        }
    </style>
</head>
<body>

<div id="scanlines"></div>

<!-- SPLASH SCREEN -->
<div id="splash-screen">
    <div style="font-size: 50px; margin-bottom: 15px;">â˜£</div>
    <h1 style="letter-spacing: 8px;">KHEM.OS</h1>
    <div id="load-text">MOUNTING SYSTEM...</div>
    <div style="width: 200px; height: 8px; border: 1px solid var(--toxic-red); margin-top: 15px; background: #111;">
        <div id="load-bar" style="height: 100%; background: var(--toxic-red); width: 0%;"></div>
    </div>
</div>

<!-- CHAT WINDOW -->
<div class="window main-window" id="chat-win">
    <div class="title-bar">
        <div class="title-bar-text">KHEM_TERMINAL_v6.1</div>
        <div class="title-bar-controls">
            <button aria-label="Minimize"></button>
            <button aria-label="Close"></button>
        </div>
    </div>
    <div class="window-body">
        <div id="chat-content"></div>
        <div class="field-row" style="margin-top: 10px;">
            <input id="msg-input" type="text" style="flex-grow: 1; background: #000; color: var(--toxic-green); border: 1px solid #444;" placeholder="Input data...">
            <button id="send-btn">SEND</button>
        </div>
        <div class="field-row" style="font-size: 10px; justify-content: space-between;">
            <span id="uid-display">IDENT: SCANNING...</span>
            <button onclick="window.editProfile()" style="height: 18px; padding: 0 5px;">MOD_PROFILE</button>
        </div>
    </div>
</div>

<!-- MP3 PLAYER -->
<div class="window" id="mp3-window">
    <div class="title-bar">
        <div class="title-bar-text">MP3Together_PUMP</div>
        <div class="title-bar-controls">
            <button aria-label="Close" onclick="document.getElementById('mp3-window').style.display='none'"></button>
        </div>
    </div>
    <div class="window-body">
        <div style="font-size: 11px; color: var(--toxic-green); margin-bottom: 5px; height: 14px; overflow: hidden;" id="track-name">TRACK: SILENT</div>
        <div class="visualizer-container" id="visualizer"></div>
        <div class="field-row-stacked">
            <label>Load MP3 to Channel:</label>
            <input type="file" id="audio-upload" accept="audio/*">
        </div>
        <div class="field-row" style="justify-content: center; margin-top: 10px;">
            <button id="sync-btn" style="color: var(--toxic-green);">CONNECT AUDIO</button>
            <button id="skip-btn" style="display:none; color: red;">SKIP</button>
        </div>
    </div>
</div>

<!-- ADMIN PANEL -->
<div class="window" id="admin-panel">
    <div class="title-bar">
        <div class="title-bar-text">ROOT_OVERRIDE_CONSOLE</div>
        <div class="title-bar-controls">
            <button aria-label="Close" onclick="document.getElementById('admin-panel').style.display='none'"></button>
        </div>
    </div>
    <div class="window-body">
        <div class="field-row">
            <label>Target:</label>
            <select id="user-sel" style="width: 100%;"></select>
        </div>
        <button onclick="window.adminRename()" style="width: 100%;">FORCE RENAME</button>
        <hr>
        <div class="field-row">
            <button onclick="window.sendEvent('shake')">SHAKE</button>
            <button onclick="window.sendEvent('glitch')">GLITCH</button>
            <button onclick="window.sendEvent('reset')">RESTORE</button>
        </div>
        <input type="color" id="bg-picker" style="width: 100%; height: 25px; margin-top: 10px;">
    </div>
</div>

<!-- DESKTOP -->
<div class="desktop-icons">
    <div class="icon" id="icon-mp3">
        <img src="https://win98icons.alexmeub.com/icons/png/cd_audio_cd-4.png">
        <div>MP3Together</div>
    </div>
    <div class="icon" id="icon-root">
        <img src="https://win98icons.alexmeub.com/icons/png/warning_outline-0.png" style="filter: hue-rotate(100deg);">
        <div>KHEM.ROOT</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, limitToLast, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7THaNrq5OdU_b9GuU82AQsnyy_Eewey4",
        authDomain: "chatroon-4ded8.firebaseapp.com",
        databaseURL: "https://chatroon-4ded8-default-rtdb.firebaseio.com",
        projectId: "chatroon-4ded8",
        storageBucket: "chatroon-4ded8.firebasestorage.app",
        messagingSenderId: "779421378038",
        appId: "1:779421378038:web:2e4b804b316b23882f93d7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, 'messages');
    const usersRef = ref(db, 'users');
    const musicRef = ref(db, 'music_v2');
    const eventsRef = ref(db, 'global_events');

    let isAdmin = false;
    let myUid = localStorage.getItem('khem_uid_v6') || 'khem-' + Math.random().toString(36).substr(2, 6);
    localStorage.setItem('khem_uid_v6', myUid);
    document.getElementById('uid-display').innerText = "IDENT: " + myUid;

    // --- CRITICAL FIX: WINDOW DRAGGING ---
    function initDragging() {
        const windows = document.querySelectorAll('.window');
        windows.forEach(win => {
            const titleBar = win.querySelector('.title-bar');
            let isDragging = false;
            let offset = { x: 0, y: 0 };

            titleBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                offset.x = e.clientX - win.offsetLeft;
                offset.y = e.clientY - win.offsetTop;
                
                // Bring to front
                windows.forEach(w => w.style.zIndex = 10);
                win.style.zIndex = 100;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                win.style.left = (e.clientX - offset.x) + "px";
                win.style.top = (e.clientY - offset.y) + "px";
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        });
    }

    // --- CRITICAL FIX: ADMIN LOGIN ---
    document.getElementById('icon-root').addEventListener('dblclick', () => {
        const pass = prompt("SYSTEM ACCESS KEY REQUIRED:");
        if (pass === "PineappleToasterOven42069") {
            isAdmin = true;
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('skip-btn').style.display = 'inline-block';
            alert("ROOT PRIVILEGES ACTIVATED.");
            renderChat();
        } else if (pass !== null) {
            alert("ACCESS DENIED: INCORRECT KEY");
        }
    });

    document.getElementById('icon-mp3').addEventListener('dblclick', () => {
        document.getElementById('mp3-window').style.display = 'block';
    });

    // --- AUDIO & SYNC ---
    let audio = new Audio();
    let audioCtx, analyser, dataArray;
    
    document.getElementById('sync-btn').onclick = () => {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 64;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            const viz = document.getElementById('visualizer');
            viz.innerHTML = '';
            for(let i=0; i<bufferLength; i++) {
                const b = document.createElement('div');
                b.className = 'bar';
                viz.appendChild(b);
            }
            
            const updateViz = () => {
                requestAnimationFrame(updateViz);
                analyser.getByteFrequencyData(dataArray);
                const bars = viz.querySelectorAll('.bar');
                dataArray.forEach((v, i) => {
                    if(bars[i]) bars[i].style.height = (v/2.5) + "%";
                });
            };
            updateViz();
        }
        audio.play().catch(() => alert("Click again to confirm audio playback."));
    };

    onValue(musicRef, (s) => {
        const d = s.val();
        if(!d || !d.url) return;
        document.getElementById('track-name').innerText = "TRACK: " + (d.name || "UNNAMED");
        const offset = (Date.now() - d.startTime) / 1000;
        if (audio.src !== d.url) {
            audio.src = d.url;
            audio.load();
        }
        if (Math.abs(audio.currentTime - offset) > 2) audio.currentTime = offset;
        audio.play().catch(() => {});
    });

    document.getElementById('audio-upload').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            update(musicRef, { url: ev.target.result, name: file.name, startTime: Date.now() });
        };
        reader.readAsDataURL(file);
    };

    // --- CHAT LOGIC ---
    let users = {};
    let messages = [];

    onValue(usersRef, s => {
        users = s.val() || {};
        if(!users[myUid]) set(ref(db, `users/${myUid}`), { username: "Subj_"+myUid.slice(-3), color: "#00ff41", pfp: "" });
        const sel = document.getElementById('user-sel');
        sel.innerHTML = "";
        Object.keys(users).forEach(u => {
            const o = document.createElement('option');
            o.value = u; o.innerText = users[u].username; sel.appendChild(o);
        });
    });

    onValue(query(chatRef, limitToLast(50)), s => {
        messages = [];
        s.forEach(c => messages.push({ k: c.key, ...c.val() }));
        renderChat();
    });

    function renderChat() {
        const c = document.getElementById('chat-content');
        c.innerHTML = "";
        messages.forEach(m => {
            const u = users[m.uid] || { username: "DEAD_NODE", color: "#666" };
            const div = document.createElement('div');
            div.className = 'message-entry';
            div.innerHTML = `
                <img class="pfp-icon" src="${u.pfp || 'https://win98icons.alexmeub.com/icons/png/user_world-0.png'}">
                <span style="color:${u.color}; font-weight:bold">${u.username}:</span> 
                <span>${m.text}</span>
                ${isAdmin ? `<button style="float:right; height:16px; padding:0 2px" onclick="window.del('${m.k}')">X</button>` : ''}
            `;
            c.appendChild(div);
        });
        c.scrollTop = c.scrollHeight;
    }

    document.getElementById('send-btn').onclick = () => {
        const t = document.getElementById('msg-input').value;
        if(!t) return;
        push(chatRef, { uid: myUid, text: t, time: serverTimestamp() });
        document.getElementById('msg-input').value = "";
    };

    // --- PROFILE ---
    window.editProfile = () => {
        const n = prompt("Change Designation:", users[myUid].username);
        const c = prompt("Change Color (CSS/Hex):", users[myUid].color);
        if(n) update(ref(db, `users/${myUid}`), { username: n, color: c || "#00ff41" });
    };

    // --- ADMIN ACTIONS ---
    window.adminRename = () => {
        const uid = document.getElementById('user-sel').value;
        const n = prompt("Force Rename:");
        if(uid && n) update(ref(db, `users/${uid}`), { username: n });
    };

    window.sendEvent = (type) => update(eventsRef, { type, timestamp: Date.now() });
    
    onValue(eventsRef, s => {
        const ev = s.val();
        if(!ev) return;
        document.body.classList.toggle('glitch-active', ev.type === 'glitch');
        if(ev.type === 'shake') {
            let count = 0;
            const si = setInterval(() => {
                document.body.style.setProperty('--shake-x', (Math.random()*10-5)+'px');
                document.body.style.setProperty('--shake-y', (Math.random()*10-5)+'px');
                if(++count > 20) { clearInterval(si); document.body.style.setProperty('--shake-x','0px'); document.body.style.setProperty('--shake-y','0px'); }
            }, 50);
        }
        if(ev.type === 'reset') { document.body.style.backgroundColor = '#1a1a1a'; document.body.classList.remove('glitch-active'); }
        if(ev.bg) document.body.style.backgroundColor = ev.bg;
    });

    document.getElementById('bg-picker').onchange = (e) => update(eventsRef, { bg: e.target.value });
    window.del = (k) => remove(ref(db, `messages/${k}`));
    document.getElementById('skip-btn').onclick = () => remove(musicRef);

    // --- STARTUP ---
    setTimeout(() => {
        let p = 0;
        const iv = setInterval(() => {
            p += 4;
            document.getElementById('load-bar').style.width = p + "%";
            if(p >= 100) { clearInterval(iv); document.getElementById('splash-screen').style.display = 'none'; }
        }, 50);
    }, 400);

    initDragging();
</script>
</body>
</html>
