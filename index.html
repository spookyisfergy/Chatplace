<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHEM.OS_ULTIMATE_v13.0_FINANCE</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <style>
        :root {
            --os-bg: #008080;
            --toxic-green: #39ff14;
            --taskbar-bg: #c0c0c0;
            --win-title: #000080;
            --win-text: #ffffff;
            --gold: #ffd700;
            --user-theme: #008080;
            --user-txt: #ffffff;
        }

        body {
            background-color: var(--user-theme);
            color: var(--user-txt);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-family: "Pixelated MS Sans Serif", Arial, sans-serif;
            overflow: hidden;
            transition: background-color 0.3s, filter 0.3s;
        }

        body.inverted { filter: invert(1); }
        body.shaking { animation: shake 0.2s infinite; }
        body.frozen { pointer-events: none !important; cursor: wait !important; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(3px, 2px) rotate(-1deg); }
            60% { transform: translate(-1px, -1px) rotate(1deg); }
            80% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #d1d1d1; z-index: 100000;
            display: flex; flex-direction: column; padding: 40px; font-family: monospace;
        }

        .desktop-area { 
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 35px); 
            padding: 20px; display: flex; flex-direction: column; flex-wrap: wrap; 
            align-content: flex-start; gap: 20px; 
        }

        .d-icon { 
            width: 85px; text-align: center; cursor: pointer; color: var(--user-txt); 
            text-shadow: 1px 1px 2px #000; font-size: 11px; user-select: none;
        }
        .d-icon img { width: 32px; height: 32px; margin-bottom: 5px; pointer-events: none; }

        .window { 
            position: absolute; min-width: 250px; display: none; 
            box-shadow: 4px 4px 10px rgba(0,0,0,0.4); z-index: 100;
            color: #000; /* Standard Win98 window text */
        }
        .title-bar { cursor: move; }

        #taskbar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35px;
            background: var(--taskbar-bg); border-top: 2px solid #fff;
            display: flex; align-items: center; padding: 2px 5px; z-index: 90000;
            color: #000;
        }
        #clock { margin-left: auto; border: 2px inset #fff; padding: 2px 10px; font-size: 12px; }

        #chat-content { height: 300px; background: #fff; color: #000; border: 2px inset; overflow-y: auto; padding: 8px; }
        .chat-msg { margin-bottom: 12px; font-size: 12px; display: flex; align-items: flex-start; gap: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        
        .avatar-box { 
            width: 40px; height: 40px; border: 1px solid #000; background: #eee; 
            flex-shrink: 0; overflow: hidden; display: flex; align-items: center; 
            justify-content: center; font-size: 24px;
        }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .chat-img { max-width: 240px; border: 2px solid #000; margin-top: 5px; display: block; }

        #start-menu {
            position: fixed; bottom: 35px; left: 0; width: 220px;
            background: var(--taskbar-bg); border: 2px solid #fff;
            z-index: 99999; display: none; box-shadow: 2px -2px 10px rgba(0,0,0,0.5);
            color: #000;
        }
        .start-item { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .start-item:hover { background: var(--win-title); color: #fff; }

        .color-preview {
            width: 20px; height: 20px; border: 1px solid #000; display: inline-block; vertical-align: middle;
        }
    </style>
</head>
<body onclick="window.closeStart()">

<div id="loading-screen">
    <div id="bios-text">
        KHEM.OS BIOS v13.0 (C) 2024 KHEM CORP<br>
        CPU: PENTIUM OVERDRIVE 133MHz<br>
        RAM: 64MB EDO RAM... OK<br>
        NETWORK: ETHERNET 10BASE-T... INITIALIZING...
    </div>
    <div style="width: 240px; height: 12px; border: 1px solid #555; margin-top: 20px; padding: 1px;">
        <div id="boot-progress" style="height: 100%; background: var(--toxic-green); width: 0%;"></div>
    </div>
</div>

<div class="desktop-area">
    <div class="d-icon" onclick="window.openWin('chat-win')"><img src="https://win98icons.alexmeub.com/icons/png/msie2-2.png"><div>Network_Chat</div></div>
    <div class="d-icon" onclick="window.openWin('photo-stream-win')"><img src="https://win98icons.alexmeub.com/icons/png/camera-0.png"><div>PhotoStream</div></div>
    <div class="d-icon" onclick="window.openWin('profile-win')"><img src="https://win98icons.alexmeub.com/icons/png/users-1.png"><div>Customization</div></div>
</div>

<!-- Photo Stream -->
<div class="window" id="photo-stream-win" style="width: 320px; top: 100px; left: 600px;">
    <div class="title-bar"><div class="title-bar-text">Photo Stream v1.0</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('photo-stream-win')"></button></div></div>
    <div class="window-body">
        <div style="width: 100%; background: #000; aspect-ratio: 4/3; margin-bottom: 10px; border: 2px inset;">
            <video id="live-video" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
        </div>
        <div class="field-row" style="justify-content: center; gap: 10px;">
            <button onclick="window.startLiveStream()">Connect Camera</button>
            <button onclick="window.broadcastPhoto()" style="font-weight:bold;">BROADCAST</button>
        </div>
        <canvas id="cam-canvas" style="display:none;"></canvas>
    </div>
</div>

<!-- Chat Window -->
<div class="window" id="chat-win" style="width: 500px; top: 40px; left: 100px;">
    <div class="title-bar"><div class="title-bar-text">KHEM_NET Chat Room</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('chat-win')"></button></div></div>
    <div class="window-body">
        <div style="margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
            <div style="background:#000; color:var(--gold); padding:2px 10px; border:2px inset; font-weight:bold;">BAL: $<span class="my-balance-display">0</span></div>
            <button onclick="window.triggerChatPhoto()">[ ATTACH PHOTO ]</button>
        </div>
        <div id="chat-content"></div>
        <div class="field-row" style="margin-top: 10px;">
            <input id="chat-input" type="text" placeholder="Type message..." style="flex:1" onkeydown="if(event.key==='Enter') window.sendChat()">
            <button onclick="window.sendChat()">Send</button>
        </div>
        <input type="file" id="chat-photo-input" hidden accept="image/*" onchange="window.handleChatPhoto(event)">
    </div>
</div>

<!-- Profile / Customization Setup -->
<div class="window" id="profile-win" style="width: 440px; top: 15%; left: 25%; z-index: 100001;">
    <div class="title-bar"><div class="title-bar-text">OS Appearance & Identity</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('profile-win')"></button></div></div>
    <div class="window-body">
        <div style="display: flex; gap: 15px;">
            <div style="text-align:center">
                <div id="pfp-preview" class="avatar-box" style="width:90px; height:90px; border:2px inset;">ðŸ‘¤</div>
                <div style="margin-top:5px; display:grid; grid-template-columns: 1fr; gap:2px;">
                    <button onclick="window.triggerPfpUpload()">Upload</button>
                    <button onclick="window.cycleAvatar()">Icon</button>
                </div>
                <input type="file" id="pfp-upload-input" hidden accept="image/*" onchange="window.handlePfpUpload(event)">
            </div>
            <div style="flex:1">
                <div class="field-row-stacked">
                    <label>Network Handle:</label>
                    <input id="prof-user" type="text" maxlength="15" style="width:100%">
                </div>
                <div class="field-row-stacked" style="margin-top:10px;">
                    <label>Name Display Color (Chat):</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="color" id="name-color-input" style="width:40px; height:25px;">
                        <span style="font-size:10px;">(Your handle color)</span>
                    </div>
                </div>
                <hr>
                <div class="field-row-stacked" style="margin-top:10px;">
                    <label>OS Background Color:</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="color" id="theme-color-input" style="width:40px; height:25px;">
                        <span style="font-size:10px;">(Desktop Wallpaper)</span>
                    </div>
                </div>
                <div class="field-row-stacked" style="margin-top:10px;">
                    <label>Desktop Text Color:</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="color" id="text-color-input" style="width:40px; height:25px;">
                        <span style="font-size:10px;">(Icon Labels)</span>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div style="text-align:right;">
            <button style="width: 120px; font-weight: bold;" onclick="window.saveProfile()">APPLY & SYNC</button>
        </div>
    </div>
</div>

<!-- System Modals -->
<div class="window" id="error-win" style="width: 300px; top: 45%; left: 45%; z-index: 999999;">
    <div class="title-bar"><div class="title-bar-text">System Alert</div></div>
    <div class="window-body"><div style="display:flex; gap:10px;"><img src="https://win98icons.alexmeub.com/icons/png/msg_warning-0.png"><p id="error-text"></p></div><div style="text-align:center; margin-top:10px;"><button onclick="window.closeWin('error-win')" style="width:60px">OK</button></div></div>
</div>

<div id="start-menu">
    <div style="background: var(--win-title); color: #fff; padding: 5px 10px; font-weight: bold;">KHEM.OS v13.0</div>
    <div class="start-item" onclick="window.openWin('profile-win')"><img src="https://win98icons.alexmeub.com/icons/png/settings_gear-0.png" width="16"> Personalization</div>
    <div class="start-item" onclick="window.openWin('photo-stream-win')"><img src="https://win98icons.alexmeub.com/icons/png/camera-0.png" width="16"> Photo Stream</div>
    <hr>
    <div class="start-item" onclick="location.reload()"><img src="https://win98icons.alexmeub.com/icons/png/shut_down_normal-4.png" width="16"> Restart</div>
</div>

<div id="taskbar">
    <button onclick="window.toggleStart(event)" id="start-btn">Start</button>
    <div id="clock">00:00</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'khem-os-v13-finance';

    let currentUser = null;
    let userData = {
        name: localStorage.getItem('khem_name') || "User_" + Math.floor(Math.random()*999),
        bal: parseInt(localStorage.getItem('khem_bal')) || 1000,
        avatar: "ðŸ‘¤",
        customPfp: null,
        themeColor: localStorage.getItem('khem_theme') || "#008080",
        textColor: localStorage.getItem('khem_txt') || "#ffffff",
        nameColor: localStorage.getItem('khem_name_color') || "#000000"
    };

    const avatars = ["ðŸ‘¤", "ðŸ¥·", "ðŸ§™", "ðŸ§Ÿ", "ðŸ¤–", "ðŸ¦Š", "ðŸ²", "ðŸ¤¡"];
    let avatarIndex = 0;
    let streamMedia = null;

    // --- UI HELPERS ---
    window.openWin = id => { document.getElementById(id).style.display = 'block'; document.getElementById(id).style.zIndex = Date.now(); };
    window.closeWin = id => { document.getElementById(id).style.display = 'none'; };
    window.toggleStart = e => { e.stopPropagation(); const m = document.getElementById('start-menu'); m.style.display = m.style.display==='block' ? 'none' : 'block'; };
    window.closeStart = () => { document.getElementById('start-menu').style.display = 'none'; };

    const showMsg = (txt) => {
        document.getElementById('error-text').innerText = txt;
        window.openWin('error-win');
    };

    const applyTheme = () => {
        document.documentElement.style.setProperty('--user-theme', userData.themeColor);
        document.documentElement.style.setProperty('--user-txt', userData.textColor);
        document.getElementById('theme-color-input').value = userData.themeColor;
        document.getElementById('text-color-input').value = userData.textColor;
        document.getElementById('name-color-input').value = userData.nameColor;
        document.getElementById('prof-user').value = userData.name;
        
        localStorage.setItem('khem_theme', userData.themeColor);
        localStorage.setItem('khem_txt', userData.textColor);
        localStorage.setItem('khem_name', userData.name);
        localStorage.setItem('khem_name_color', userData.nameColor);
    };

    const updateUI = () => {
        applyTheme();
        document.querySelectorAll('.my-balance-display').forEach(el => el.innerText = userData.bal.toLocaleString());
        const preview = document.getElementById('pfp-preview');
        if(userData.customPfp) {
            preview.innerHTML = `<img src="${userData.customPfp}">`;
        } else {
            preview.innerText = userData.avatar;
        }
    };

    // --- PHOTO STREAM ---
    window.startLiveStream = async () => {
        try {
            streamMedia = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('live-video').srcObject = streamMedia;
        } catch (e) { showMsg("Camera error."); }
    };

    window.broadcastPhoto = async () => {
        const video = document.getElementById('live-video');
        const canvas = document.getElementById('cam-canvas');
        if(!video.srcObject) return showMsg("Connect camera first!");
        canvas.width = 400; canvas.height = 300;
        canvas.getContext('2d').drawImage(video, 0, 0, 400, 300);
        await window.sendChat(null, canvas.toDataURL('image/jpeg', 0.6));
        showMsg("Broadcasted!");
    };

    // --- CUSTOMIZATION ---
    window.triggerPfpUpload = () => document.getElementById('pfp-upload-input').click();
    window.handlePfpUpload = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 128; canvas.height = 128;
                canvas.getContext('2d').drawImage(img, 0, 0, 128, 128);
                userData.customPfp = canvas.toDataURL('image/jpeg', 0.7);
                updateUI();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    window.cycleAvatar = () => {
        userData.customPfp = null;
        avatarIndex = (avatarIndex + 1) % avatars.length;
        userData.avatar = avatars[avatarIndex];
        updateUI();
    };

    window.saveProfile = async () => {
        userData.name = document.getElementById('prof-user').value || "Anonymous";
        userData.themeColor = document.getElementById('theme-color-input').value;
        userData.textColor = document.getElementById('text-color-input').value;
        userData.nameColor = document.getElementById('name-color-input').value;
        
        if(currentUser) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { 
                ...userData, 
                uid: currentUser.uid 
            });
        }
        updateUI();
        window.closeWin('profile-win');
    };

    // --- CHAT LOGIC ---
    window.triggerChatPhoto = () => document.getElementById('chat-photo-input').click();
    window.handleChatPhoto = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const scale = 400 / img.width;
                canvas.width = 400; canvas.height = img.height * scale;
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                await window.sendChat(null, canvas.toDataURL('image/jpeg', 0.6));
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    const setupListeners = () => {
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), (snap) => {
            const box = document.getElementById('chat-content');
            box.innerHTML = "";
            const msgs = [];
            snap.forEach(d => msgs.push(d.data()));
            msgs.sort((a,b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

            msgs.slice(-50).forEach(m => {
                const pfp = m.customPfp ? `<img src="${m.customPfp}">` : (m.avatar || 'ðŸ‘¤');
                const content = m.img ? `<img class="chat-img" src="${m.img}" onclick="window.open(this.src)">` : `<div>${m.msg || ''}</div>`;
                const userStyle = `color: ${m.nameColor || '#000000'}`;
                
                box.innerHTML += `
                    <div class="chat-msg">
                        <div class="avatar-box">${pfp}</div>
                        <div style="flex:1">
                            <b style="${userStyle}">${m.name}</b>
                            ${content}
                        </div>
                    </div>
                `;
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    window.sendChat = async (text = null, photo = null) => {
        const inp = document.getElementById('chat-input');
        const msgText = text || inp.value;
        if(!msgText && !photo) return;
        if(!currentUser) return;

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), {
                uid: currentUser.uid,
                name: userData.name,
                avatar: userData.avatar,
                customPfp: userData.customPfp,
                nameColor: userData.nameColor,
                msg: msgText || "",
                img: photo || null,
                timestamp: Timestamp.now()
            });
            inp.value = "";
        } catch (e) { console.error(e); }
    };

    // --- AUTH ---
    const initApp = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        currentUser = user;
        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
        const snap = await getDoc(ref);
        if(snap.exists()) {
            userData = { ...userData, ...snap.data() };
        } else {
            await setDoc(ref, { ...userData, uid: user.uid });
        }
        updateUI();
        setupListeners();
    });

    // Boot Loader
    window.onload = () => {
        const p = document.getElementById('boot-progress');
        let val = 0;
        const int = setInterval(() => {
            val += 5;
            p.style.width = val + "%";
            if(val >= 100) {
                clearInterval(int);
                document.getElementById('loading-screen').style.display = 'none';
                initApp();
            }
        }, 25);
        
        setInterval(() => {
            const d = new Date();
            document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
        }, 1000);
    };

    // Dragging
    let drag = null, ox = 0, oy = 0;
    document.addEventListener('mousedown', e => {
        const bar = e.target.closest('.title-bar');
        if(bar) { drag = bar.parentElement; ox = e.clientX - drag.offsetLeft; oy = e.clientY - drag.offsetTop; drag.style.zIndex = Date.now(); }
    });
    document.addEventListener('mousemove', e => { if(drag) { drag.style.left = (e.clientX - ox) + 'px'; drag.style.top = (e.clientY - oy) + 'px'; }});
    document.addEventListener('mouseup', () => drag = null);

</script>
</body>
</html>
