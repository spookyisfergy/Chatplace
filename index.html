<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHEM.OS_ULTIMATE_v13.5_FINANCE</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <style>
        :root {
            --os-bg: #008080;
            --toxic-green: #39ff14;
            --taskbar-bg: #c0c0c0;
            --win-title: #000080;
            --win-text: #ffffff;
            --gold: #ffd700;
        }

        body {
            background-color: var(--os-bg);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-family: "Pixelated MS Sans Serif", Arial, sans-serif;
            overflow: hidden;
        }

        /* Essential Animations */
        body.inverted { filter: invert(1); }
        body.shaking { animation: shake 0.2s infinite; }
        body.frozen { pointer-events: none !important; cursor: wait !important; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(3px, 2px) rotate(-1deg); }
            60% { transform: translate(-1px, -1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #d1d1d1; z-index: 100000;
            display: flex; flex-direction: column; padding: 40px; font-family: monospace;
        }

        .desktop-area { 
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 35px); 
            padding: 20px; display: flex; flex-direction: column; flex-wrap: wrap; 
            align-content: flex-start; gap: 20px; 
        }

        .d-icon { 
            width: 85px; text-align: center; cursor: pointer; color: #fff; 
            text-shadow: 1px 1px 2px #000; font-size: 11px; user-select: none;
        }
        .d-icon img { width: 32px; height: 32px; margin-bottom: 5px; pointer-events: none; }

        .window { 
            position: absolute; min-width: 250px; display: none; 
            box-shadow: 4px 4px 10px rgba(0,0,0,0.4); z-index: 100;
        }
        .title-bar { cursor: move; }

        #taskbar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35px;
            background: var(--taskbar-bg); border-top: 2px solid #fff;
            display: flex; align-items: center; padding: 2px 5px; z-index: 90000;
        }
        #clock { margin-left: auto; border: 2px inset #fff; padding: 2px 10px; font-size: 12px; }

        #chat-content { height: 300px; background: #fff; color: #000; border: 2px inset; overflow-y: auto; padding: 8px; }
        .chat-msg { margin-bottom: 12px; font-size: 12px; display: flex; align-items: flex-start; gap: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .avatar-box { width: 40px; height: 40px; border: 1px solid #000; background: #eee; flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        
        #start-menu {
            position: fixed; bottom: 35px; left: 0; width: 220px;
            background: var(--taskbar-bg); border: 2px solid #fff;
            z-index: 99999; display: none;
        }
        .start-item { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .start-item:hover { background: var(--win-title); color: #fff; }

        /* Auth Guard Layer */
        #auth-guard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 99998;
            display: none; align-items: center; justify-content: center;
        }

        .system-status-indicator {
            position: fixed; bottom: 40px; right: 10px; 
            padding: 4px 8px; background: #000; color: lime;
            font-size: 10px; font-family: monospace; border: 1px solid lime;
            z-index: 999999;
        }
    </style>
</head>
<body onclick="window.closeStart()">

<!-- Loading Screen -->
<div id="loading-screen">
    <div id="bios-text">
        KHEM.OS KERNEL LOADED...<br>
        PARSING CONFIGURATION...<br>
        MOUNTING VIRTUAL DRIVES...<br>
        ESTABLISHING FIRE_NET HANDSHAKE... <span id="boot-status">PENDING</span>
    </div>
    <div style="width: 240px; height: 12px; border: 1px solid #555; margin-top: 20px; padding: 1px;">
        <div id="boot-progress" style="height: 100%; background: var(--toxic-green); width: 0%;"></div>
    </div>
    <div style="margin-top: 20px;">
        <button id="force-boot-btn" style="display:none; color: yellow; background: none; border: 1px solid yellow; cursor: pointer;" onclick="window.startOS()">[ EMERGENCY BYPASS ]</button>
    </div>
</div>

<div id="auth-guard"></div>
<div class="system-status-indicator" id="sys-status">NET: DISCONNECTED</div>

<div class="desktop-area">
    <div class="d-icon" onclick="window.openWin('chat-win')"><img src="https://win98icons.alexmeub.com/icons/png/msie2-2.png"><div>Network_Chat</div></div>
    <div class="d-icon" onclick="window.openWin('casino-win')"><img src="https://win98icons.alexmeub.com/icons/png/joystick-0.png"><div>Casino</div></div>
    <div class="d-icon" onclick="window.openWin('mine-win')"><img src="https://win98icons.alexmeub.com/icons/png/minesweeper-0.png"><div>Mines</div></div>
</div>

<!-- Main Windows -->
<div class="window" id="chat-win" style="width: 500px; top: 40px; left: 100px;">
    <div class="title-bar"><div class="title-bar-text">KHEM_NET Chat</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('chat-win')"></button></div></div>
    <div class="window-body">
        <div style="background:#000; color:gold; padding:5px; border:2px inset; font-weight:bold; margin-bottom:5px;">BALANCE: $<span class="my-balance-display">0</span></div>
        <div id="chat-content"></div>
        <div class="field-row" style="margin-top: 10px;">
            <input id="chat-input" type="text" style="flex:1" onkeydown="if(event.key==='Enter') window.sendChat()">
            <button onclick="window.sendChat()">Send</button>
        </div>
    </div>
</div>

<div class="window" id="profile-win" style="width: 320px; top: 25%; left: 35%; z-index: 100001;">
    <div class="title-bar"><div class="title-bar-text">KHEM_ID Registration</div></div>
    <div class="window-body">
        <p>Please establish your network identity to continue.</p>
        <div class="field-row-stacked">
            <label>Username:</label>
            <input id="prof-user" type="text" maxlength="15" style="width:100%">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
            <div id="pfp-preview" class="avatar-box" style="width:60px; height:60px;">ðŸ‘¤</div>
            <button onclick="window.cycleAvatar()">Change Avatar</button>
        </div>
        <button id="save-profile-btn" style="width: 100%; margin-top: 15px; font-weight: bold;" onclick="window.saveProfile()">ENTER NETWORK</button>
    </div>
</div>

<div class="window" id="error-win" style="width: 300px; top: 45%; left: 45%; z-index: 999999;">
    <div class="title-bar"><div class="title-bar-text">System Alert</div></div>
    <div class="window-body"><p id="error-text"></p><div style="text-align:center;"><button onclick="window.closeWin('error-win')">OK</button></div></div>
</div>

<div id="taskbar">
    <button onclick="window.toggleStart(event)" id="start-btn">Start</button>
    <div id="clock">00:00</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIG ---
    let db, auth, currentUser;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'khem-os-finance-v13';
    
    // --- STATE ---
    let userData = { name: "", bal: 1000, avatar: "ðŸ‘¤", initialized: false };
    const avatars = ["ðŸ‘¤", "ðŸ¥·", "ðŸ§™", "ðŸ§Ÿ", "ðŸ¤–", "ðŸ¦Š", "ðŸ²", "ðŸ¤¡"];
    let avatarIndex = 0;
    let isBooted = false;

    // --- SYSTEM CORE ---
    window.startOS = () => {
        if (isBooted) return;
        isBooted = true;
        document.getElementById('loading-screen').style.display = 'none';
        console.log("OS Boot Complete.");
    };

    window.openWin = id => { document.getElementById(id).style.display = 'block'; document.getElementById(id).style.zIndex = Date.now(); };
    window.closeWin = id => { document.getElementById(id).style.display = 'none'; };
    window.toggleStart = e => { e.stopPropagation(); const m = document.getElementById('start-menu'); m.style.display = m.style.display==='block' ? 'none' : 'block'; };
    window.closeStart = () => { if(document.getElementById('start-menu')) document.getElementById('start-menu').style.display = 'none'; };

    const updateUI = () => {
        document.querySelectorAll('.my-balance-display').forEach(el => el.innerText = (userData.bal || 0).toLocaleString());
        document.getElementById('pfp-preview').innerText = userData.avatar;
        if(userData.initialized) {
            document.getElementById('auth-guard').style.display = 'none';
            window.closeWin('profile-win');
        } else {
            document.getElementById('auth-guard').style.display = 'flex';
            window.openWin('profile-win');
        }
    };

    // --- DATA HANDLING ---
    const initFirebase = async () => {
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            document.getElementById('boot-status').innerText = "CONNECTING...";
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, async (user) => {
                if (!user) return;
                currentUser = user;
                document.getElementById('sys-status').innerText = "NET: CONNECTED";
                document.getElementById('boot-status').innerText = "OK";
                
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                const snap = await getDoc(userRef);
                
                if (snap.exists()) {
                    userData = { ...userData, ...snap.data() };
                    userData.initialized = true;
                }
                
                updateUI();
                setupListeners();
                setTimeout(window.startOS, 500); // Final delay for smoothness
            });

        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            document.getElementById('boot-status').innerText = "OFFLINE_MODE";
            document.getElementById('sys-status').innerText = "NET: OFFLINE";
            document.getElementById('force-boot-btn').style.display = 'block';
        }
    };

    const setupListeners = () => {
        if (!currentUser) return;
        // Simple chat listener
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), (snap) => {
            const box = document.getElementById('chat-content');
            box.innerHTML = "";
            const msgs = [];
            snap.forEach(d => msgs.push(d.data()));
            msgs.sort((a,b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
            msgs.slice(-30).forEach(m => {
                box.innerHTML += `<div class="chat-msg">
                    <div class="avatar-box">${m.avatar || 'ðŸ‘¤'}</div>
                    <div style="flex:1"><b>${m.name}</b><br>${m.msg}</div>
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        }, (err) => console.log("Chat error", err));
    };

    window.saveProfile = async () => {
        const name = document.getElementById('prof-user').value;
        if (!name || name.length < 2) return;
        userData.name = name;
        userData.initialized = true;
        if (currentUser) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), {
                name: userData.name,
                bal: userData.bal,
                avatar: userData.avatar,
                initialized: true
            });
        }
        updateUI();
    };

    window.cycleAvatar = () => {
        avatarIndex = (avatarIndex + 1) % avatars.length;
        userData.avatar = avatars[avatarIndex];
        updateUI();
    };

    window.sendChat = async () => {
        const inp = document.getElementById('chat-input');
        if (!inp.value || !userData.initialized) return;
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), {
            name: userData.name,
            avatar: userData.avatar,
            msg: inp.value,
            timestamp: Timestamp.now()
        });
        inp.value = "";
    };

    // --- BOOT SEQUENCE ---
    window.onload = () => {
        const prog = document.getElementById('boot-progress');
        let p = 0;
        const int = setInterval(() => {
            p += Math.random() * 8;
            if (p > 100) p = 100;
            prog.style.width = p + "%";
            if (p >= 100) {
                clearInterval(int);
                initFirebase();
                // If it hasn't booted in 10 seconds, show the emergency button
                setTimeout(() => {
                    if (!isBooted) document.getElementById('force-boot-btn').style.display = 'block';
                }, 10000);
            }
        }, 80);
    };

    // Clock
    setInterval(() => {
        const d = new Date();
        document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
    }, 1000);

    // Simple Dragging
    let dWin = null, dOff = {x:0,y:0};
    document.addEventListener('mousedown', e => {
        const bar = e.target.closest('.title-bar');
        if(bar){ dWin = bar.parentElement; dWin.style.zIndex = Date.now(); dOff.x = e.clientX - dWin.offsetLeft; dOff.y = e.clientY - dWin.offsetTop; }
    });
    document.addEventListener('mousemove', e => { if(dWin){ dWin.style.left = (e.clientX-dOff.x)+"px"; dWin.style.top = (e.clientY-dOff.y)+"px"; }});
    document.addEventListener('mouseup', () => dWin = null);
</script>
</body>
</html>
