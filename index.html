<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHEM.OS_ULTIMATE_v9.7</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <style>
        :root {
            --os-bg: #008080;
            --toxic-green: #39ff14;
            --taskbar-bg: #c0c0c0;
            --win-title: #000080;
            --win-text: #ffffff;
            --bios-text: #d1d1d1;
        }

        body {
            background-color: var(--os-bg);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-family: "Pixelated MS Sans Serif", Arial, sans-serif;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        @keyframes rainbow {
            0% { color: #ff0000; text-shadow: 0 0 5px #ff0000; }
            20% { color: #ff8800; }
            40% { color: #ffff00; }
            60% { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
            80% { color: #0000ff; }
            100% { color: #ff00ff; }
        }
        .hacker-name { animation: rainbow 2s infinite linear; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .hacker-tag { background: #000; color: var(--toxic-green); font-size: 9px; padding: 1px 3px; border: 1px solid var(--toxic-green); margin-right: 5px; }

        .dark-mode-win .title-bar { background: #333 !important; }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: var(--bios-text); z-index: 30000;
            display: flex; flex-direction: column; padding: 40px; font-family: 'Courier New', monospace;
        }
        .bios-line { margin-bottom: 5px; font-size: 14px; opacity: 0; animation: fadeIn 0.1s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }

        .loading-bar-container { width: 300px; height: 14px; border: 1px solid #555; margin-top: 20px; padding: 2px; }
        .loading-fill { height: 100%; background: var(--toxic-green); width: 0%; box-shadow: 0 0 8px var(--toxic-green); }

        #taskbar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 35px;
            background: var(--taskbar-bg); border-top: 2px solid #fff;
            display: flex; align-items: center; padding: 2px;
            z-index: 10000; box-sizing: border-box;
        }
        #start-btn { font-weight: bold; display: flex; align-items: center; gap: 5px; height: 28px; }
        #clock { margin-left: auto; border: 2px inset #fff; padding: 2px 10px; font-size: 12px; background: #c0c0c0; }
        
        #start-menu {
            position: fixed; bottom: 35px; left: 0; width: 220px;
            background: var(--taskbar-bg); border: 2px solid #fff;
            z-index: 9999; display: none;
            box-shadow: 2px -2px 10px rgba(0,0,0,0.5);
        }
        .start-item { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .start-item:hover { background: var(--win-title); color: #fff; }

        .window { position: absolute; z-index: 10; box-shadow: 4px 4px 15px rgba(0,0,0,0.3); display: none; min-width: 200px; }
        .title-bar { cursor: grab; user-select: none; }
        
        .desktop-area { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 35px); padding: 20px; display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; gap: 15px; }
        .d-icon { width: 85px; text-align: center; cursor: pointer; color: #fff; text-shadow: 1px 1px 2px #000; font-size: 11px; }
        .d-icon img { width: 32px; height: 32px; margin-bottom: 4px; pointer-events: none; }

        .chat-msg { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 12px; font-size: 12px; padding: 4px; }
        .chat-msg.admin-editable:hover { background: rgba(255, 255, 0, 0.2); cursor: pointer; border: 1px dashed red; }
        .avatar-sm { width: 32px; height: 32px; border: 1px solid #000; background: #eee; object-fit: cover; }
        #chat-content { height: 280px; background: #fff; color: #000; border: 2px inset; overflow-y: scroll; padding: 8px; }
        .chat-img { max-width: 200px; max-height: 150px; border: 2px solid #c0c0c0; margin-top: 5px; cursor: pointer; }
        
        .pfp-preview { width: 64px; height: 64px; border: 2px inset #fff; background: #eee; object-fit: cover; margin-bottom: 10px; }

        .mine-cell { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-size: 14px; user-select: none; box-sizing: border-box; }
        .cell-hidden { background: #c0c0c0; border: 2px outset #fff; }
        .cell-revealed { background: #bdbdbd; border: 1px solid #7b7b7b; }
        
        #casino-reel { height: 40px; background: #222; border: 2px inset; display: flex; align-items: center; justify-content: center; font-size: 24px; letter-spacing: 5px; margin-bottom: 10px; }
        
        #webcam-view { width: 100%; height: auto; background: #000; border: 2px inset; margin-bottom: 10px; transform: scaleX(-1); }
        .voice-meter { width: 100%; height: 20px; background: #000; border: 2px inset; position: relative; overflow: hidden; }
        .voice-level { height: 100%; background: linear-gradient(90deg, #0f0, #ff0, #f00); width: 0%; transition: width 0.1s; }
        #participants-list { border: 2px inset; background: #eee; padding: 5px; height: 60px; overflow-y: auto; font-size: 11px; margin-bottom: 10px; }
    </style>
</head>
<body onclick="window.hideStart()">

<div id="login-lock" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:25000; display:none; flex-direction:column; align-items:center; justify-content:center; color:white; text-align:center;">
    <img src="https://win98icons.alexmeub.com/icons/png/key_win-4.png" width="64" style="margin-bottom:20px;">
    <h2 style="font-family:monospace; color:var(--toxic-green);">KHEM.OS_SECURITY_GATE</h2>
    <p>Identity verification required to establish network handshake.</p>
</div>

<div id="loading-screen">
    <div id="bios-log"></div>
    <div class="loading-bar-container" id="load-bar-ui" style="display:none;">
        <div id="loading-fill" class="loading-fill"></div>
    </div>
</div>

<div class="desktop-area" id="desktop">
    <div class="d-icon" onclick="window.openWin('chat-win')"><img src="https://win98icons.alexmeub.com/icons/png/msie2-2.png"><div>Network_Chat</div></div>
    <div class="d-icon" onclick="window.openWin('voice-win')"><img src="https://win98icons.alexmeub.com/icons/png/loudspeaker_rays-0.png"><div>Voice_Terminal</div></div>
    <div class="d-icon" onclick="window.openWin('paint-win')"><img src="https://win98icons.alexmeub.com/icons/png/paint_old-0.png"><div>Shared_Paint</div></div>
    <div class="d-icon" onclick="window.openWin('gamble-win')"><img src="https://win98icons.alexmeub.com/icons/png/joystick-0.png"><div>KHEM_Casino</div></div>
    <div class="d-icon" onclick="window.openWin('mine-win')"><img src="https://win98icons.alexmeub.com/icons/png/minesweeper-0.png"><div>Minesweeper</div></div>
    <div class="d-icon" onclick="window.openWin('display-win')"><img src="https://win98icons.alexmeub.com/icons/png/display_properties-0.png"><div>Display</div></div>
</div>

<div id="start-menu">
    <div style="background: var(--win-title); color: #fff; padding: 5px 10px; font-weight: bold; font-size: 14px;">KHEM.OS v9.7</div>
    <div class="start-item" onclick="window.authAdmin()"><img src="https://win98icons.alexmeub.com/icons/png/key_win-4.png" width="16"> Admin Console</div>
    <div class="start-item" onclick="window.openWin('profile-win')"><img src="https://win98icons.alexmeub.com/icons/png/user_world-0.png" width="16"> Edit Profile</div>
    <hr>
    <div class="start-item" onclick="location.reload()"><img src="https://win98icons.alexmeub.com/icons/png/shut_down_normal-4.png" width="16"> Shutdown</div>
</div>

<div id="taskbar">
    <button id="start-btn" onclick="window.toggleStart(event)"><img src="https://win98icons.alexmeub.com/icons/png/windows-0.png" width="16"> Start</button>
    <div id="clock">00:00</div>
</div>

<!-- ALL ORIGINAL WINDOWS RESTORED -->
<div class="window" id="profile-win" style="width: 320px; top: 25%; left: 35%; z-index: 26000;">
    <div class="title-bar"><div class="title-bar-text">Identity Setup</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('profile-win')"></button></div></div>
    <div class="window-body">
        <div style="display: flex; gap: 15px;">
            <div style="text-align:center">
                <img id="pfp-preview" class="pfp-preview" src="https://win98icons.alexmeub.com/icons/png/user_world-0.png">
                <button onclick="document.getElementById('pfp-input').click()" style="width:100%">Photo</button>
                <input type="file" id="pfp-input" accept="image/*" style="display:none">
            </div>
            <div style="flex:1">
                <div class="field-row-stacked">
                    <label>Network Handle:</label>
                    <input id="prof-user" type="text" maxlength="15" style="width:100%">
                </div>
                <div class="field-row-stacked" style="margin-top:8px">
                    <label>Handle Color:</label>
                    <input id="prof-color" type="color" value="#39ff14" style="width:100%">
                </div>
            </div>
        </div>
        <button style="width: 100%; margin-top: 15px; font-weight: bold; height: 30px;" onclick="window.saveProfile()">SYNC & CONNECT</button>
    </div>
</div>

<div class="window" id="chat-win" style="width: 480px; top: 50px; left: 100px;">
    <div class="title-bar"><div class="title-bar-text">KHEM_NET_v9.7</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('chat-win')"></button></div></div>
    <div class="window-body">
        <div id="chat-content"></div>
        <div class="field-row" style="margin-top:5px">
            <input id="chat-input" type="text" style="flex:1" placeholder="Enter message..." onkeydown="if(event.key==='Enter') window.sendChat()">
            <button onclick="window.openWin('voice-win')" title="Voice Terminal">üéôÔ∏è</button>
            <button onclick="window.openWin('webcam-win')" title="Setup Photo">üì∑</button>
            <button onclick="document.getElementById('chat-img-input').click()" title="Upload Image">üìé</button>
            <input type="file" id="chat-img-input" accept="image/*" style="display:none" onchange="window.handleChatImage(this)">
            <button onclick="window.sendChat()">SEND</button>
        </div>
    </div>
</div>

<!-- UPDATED VOICE TERMINAL (PEER-TO-PEER) -->
<div class="window" id="voice-win" style="width: 300px; top: 100px; left: 600px;">
    <div class="title-bar"><div class="title-bar-text">Voice_Terminal</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('voice-win')"></button></div></div>
    <div class="window-body">
        <p style="margin-top:0;">Broadcasting: <b id="voice-status" style="color:red">OFFLINE</b></p>
        <div id="participants-list"></div>
        <div class="voice-meter"><div id="voice-level" class="voice-level"></div></div>
        <div class="field-row" style="margin-top:10px; justify-content: center;">
            <button id="voice-join-btn" onclick="window.joinCall()" style="flex:1">JOIN CALL</button>
            <button id="voice-leave-btn" onclick="window.leaveCall()" style="flex:1" disabled>LEAVE</button>
        </div>
        <p style="font-size:9px; margin-top:5px; opacity:0.6;">* You won't hear yourself, only other users.</p>
    </div>
</div>

<div class="window" id="webcam-win" style="width: 320px; top: 150px; left: 600px;">
    <div class="title-bar"><div class="title-bar-text">Hardware_Showcase</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.stopWebcam()"></button></div></div>
    <div class="window-body">
        <video id="webcam-view" autoplay playsinline></video>
        <canvas id="cam-capture" style="display:none"></canvas>
        <div class="cam-controls" style="display:flex; gap:5px;">
            <button onclick="window.startWebcam()" style="flex:1">Initialize</button>
            <button onclick="window.takePhoto()" style="flex:1; font-weight:bold;">SNAPSHOT</button>
        </div>
    </div>
</div>

<div class="window" id="admin-win" style="width: 320px; top: 30%; left: 40%;">
    <div class="title-bar" style="background: #000 !important; border-bottom: 1px solid var(--toxic-green) !important;"><div class="title-bar-text" style="color: var(--toxic-green);">[ROOT]@KHEM_KERNEL_ACCESS</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('admin-win')"></button></div></div>
    <div class="window-body" style="background: #000; color: var(--toxic-green); font-family: 'Courier New', monospace;">
        <button onclick="window.adminGlobalMute()" style="width:100%; background:#222; color:red;">[ ERASE_LOGS ]</button>
        <button onclick="window.adminFlash()" style="width:100%; margin-top:5px; background:#222; color:var(--toxic-green);">[ SYSTEM_GLITCH_ALERT ]</button>
        <button onclick="window.adminNukePaint()" style="width:100%; margin-top:5px; background:#222; color:yellow;">[ PURGE_CANVAS ]</button>
    </div>
</div>

<div class="window" id="mine-win" style="width: 260px; top: 100px; left: 800px;">
    <div class="title-bar"><div class="title-bar-text">Minesweeper</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('mine-win')"></button></div></div>
    <div class="window-body"><div id="mine-grid" style="display:grid; grid-template-columns:repeat(10,22px); gap:0; background:#808080; border:2px inset;"></div><button onclick="window.initMines()" style="width:100%; margin-top:5px;">Reset Game</button></div>
</div>

<div class="window" id="gamble-win" style="width: 250px; top: 350px; left: 600px;">
    <div class="title-bar"><div class="title-bar-text">Casino</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('gamble-win')"></button></div></div>
    <div class="window-body">
        <div style="background:#000; color:gold; text-align:center; padding:10px; border:2px inset; font-family:monospace;">$<span id="gamble-bal">0</span></div>
        <div id="casino-reel">üçí üîî üíé</div>
        <input id="bet-amt" type="number" value="50" style="width:100%">
        <button onclick="window.playCasino()" style="width:100%; margin-top:10px;">SPIN</button>
    </div>
</div>

<div class="window" id="paint-win" style="width: 420px; top: 400px; left: 50px;"><div class="title-bar"><div class="title-bar-text">Shared_Paint</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('paint-win')"></button></div></div><div class="window-body"><canvas id="paint-canvas" width="400" height="300" style="background:#fff; border:2px inset;"></canvas><div class="field-row"><input type="color" id="brush-color" value="#000000"><button onclick="window.clearPaint()">Clear</button></div></div></div>
<div class="window" id="display-win" style="width: 300px; top: 200px; left: 600px;"><div class="title-bar"><div class="title-bar-text">Display</div><div class="title-bar-controls"><button aria-label="Close" onclick="window.closeWin('display-win')"></button></div></div><div class="window-body"><fieldset><legend>Background</legend><select style="width: 100%;" onchange="window.updateBg(this.value)"><option value="classic">Teal</option><option value="cyber">Cyber</option><option value="xp">XP Bliss</option></select></fieldset><div class="field-row" style="margin-top:10px"><input type="checkbox" id="dark-mode-chk" onchange="window.toggleDarkMode(this.checked)"><label for="dark-mode-chk">Dark Mode</label></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, onChildAdded, onChildRemoved, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7THaNrq5OdU_b9GuU82AQsnyy_Eewey4",
        authDomain: "chatroon-4ded8.firebaseapp.com",
        databaseURL: "https://chatroon-4ded8-default-rtdb.firebaseio.com",
        projectId: "chatroon-4ded8",
        appId: "1:779421378038:web:2e4b804b316b23882f93d7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbVer = "v9_7_stable";
    const myUid = localStorage.getItem('khem_uid_v97') || 'U-' + Math.random().toString(36).substr(2, 6);
    localStorage.setItem('khem_uid_v97', myUid);

    let myData = { 
        username: localStorage.getItem('khem_name') || null, 
        color: localStorage.getItem('khem_color') || '#39ff14', 
        pfp: localStorage.getItem('khem_pfp') || 'https://win98icons.alexmeub.com/icons/png/user_world-0.png',
        bal: parseInt(localStorage.getItem('khem_bal')) || 5000,
        bg: localStorage.getItem('khem_bg') || 'classic',
        dark: localStorage.getItem('khem_dark') === 'true'
    };

    let isAdmin = false;
    const PW = "PineAppleToasterOven";

    // --- BOOT ---
    const biosLog = document.getElementById('bios-log');
    const lines = ["KHEMBIOS v4.97", "NETWORK: ENCRYPTED", "VERSION: 9.7", "Starting KHEM.OS..."];
    let lIdx = 0;
    (function runBios() {
        if(lIdx < lines.length) {
            const d = document.createElement('div'); d.className='bios-line'; d.innerText=lines[lIdx++]; biosLog.appendChild(d);
            setTimeout(runBios, 150);
        } else {
            document.getElementById('load-bar-ui').style.display='block';
            let p = 0;
            const iv = setInterval(() => {
                p += 5; document.getElementById('loading-fill').style.width = p + "%";
                if(p >= 100) { clearInterval(iv); bootSystem(); }
            }, 20);
        }
    })();

    function bootSystem() {
        document.getElementById('loading-screen').style.display = 'none';
        window.updateBg(myData.bg);
        window.toggleDarkMode(myData.dark);
        document.getElementById('gamble-bal').innerText = myData.bal;
        if(!myData.username) {
            document.getElementById('login-lock').style.display = 'flex';
            window.openWin('profile-win');
        } else {
            document.getElementById('prof-user').value = myData.username;
            document.getElementById('pfp-preview').src = myData.pfp;
            window.openWin('chat-win');
        }
    }

    // --- CORE HANDLERS ---
    window.toggleStart = (e) => { e.stopPropagation(); const m = document.getElementById('start-menu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; };
    window.hideStart = () => document.getElementById('start-menu').style.display = 'none';
    window.openWin = (id) => { const w = document.getElementById(id); w.style.display = 'block'; w.style.zIndex = Math.floor(Date.now()/1000); };
    window.closeWin = (id) => document.getElementById(id).style.display = 'none';

    // --- VOICE (WEBRTC MESH) ---
    let localStream = null;
    let isCallActive = false;
    const pcMap = new Map();
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    window.joinCall = async () => {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            isCallActive = true;
            document.getElementById('voice-status').innerText = "LIVE";
            document.getElementById('voice-status').style.color = "var(--toxic-green)";
            document.getElementById('voice-join-btn').disabled = true;
            document.getElementById('voice-leave-btn').disabled = false;
            
            // Register as active
            set(ref(db, `${dbVer}/voice_participants/${myUid}`), { name: myData.username });
            
            // Audio visualizer
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaStreamSource(localStream);
            const analyser = audioCtx.createAnalyser();
            source.connect(analyser);
            const dataArr = new Uint8Array(analyser.frequencyBinCount);
            const viz = () => {
                if(!isCallActive) return;
                analyser.getByteFrequencyData(dataArr);
                let sum = dataArr.reduce((a,b)=>a+b,0);
                document.getElementById('voice-level').style.width = (sum/dataArr.length)*2 + "%";
                requestAnimationFrame(viz);
            };
            viz();
        } catch(e) { alert("Mic Access Denied."); }
    };

    window.leaveCall = () => {
        isCallActive = false;
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        remove(ref(db, `${dbVer}/voice_participants/${myUid}`));
        pcMap.forEach(pc => pc.close());
        pcMap.clear();
        document.getElementById('voice-status').innerText = "OFFLINE";
        document.getElementById('voice-status').style.color = "red";
        document.getElementById('voice-join-btn').disabled = false;
        document.getElementById('voice-leave-btn').disabled = true;
    };

    // Signaling
    onChildAdded(ref(db, `${dbVer}/voice_participants`), (snap) => {
        if(snap.key === myUid || !isCallActive) return;
        createPC(snap.key, true);
    });
    onChildRemoved(ref(db, `${dbVer}/voice_participants`), (snap) => {
        if(pcMap.has(snap.key)) { pcMap.get(snap.key).close(); pcMap.delete(snap.key); }
    });
    onChildAdded(ref(db, `${dbVer}/signaling/${myUid}`), async (snap) => {
        const d = snap.val(); if(!isCallActive) return;
        let pc = pcMap.get(d.from) || createPC(d.from, false);
        if(d.type === 'offer') {
            await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
            const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
            push(ref(db, `${dbVer}/signaling/${d.from}`), { type:'answer', answer:ans, from:myUid });
        } else if(d.type === 'answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
        } else if(d.type === 'candidate') {
            pc.addIceCandidate(new RTCIceCandidate(d.candidate));
        }
        remove(ref(db, `${dbVer}/signaling/${myUid}/${snap.key}`));
    });

    function createPC(pId, isOffer) {
        const pc = new RTCPeerConnection(servers);
        pcMap.set(pId, pc);
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.onicecandidate = (e) => e.candidate && push(ref(db, `${dbVer}/signaling/${pId}`), { type:'candidate', candidate:e.candidate, from:myUid });
        pc.ontrack = (e) => { const a = new Audio(); a.srcObject = e.streams[0]; a.autoplay = true; };
        if(isOffer) {
            pc.onnegotiationneeded = async () => {
                const off = await pc.createOffer(); await pc.setLocalDescription(off);
                push(ref(db, `${dbVer}/signaling/${pId}`), { type:'offer', offer:off, from:myUid });
            };
        }
        return pc;
    }

    onValue(ref(db, `${dbVer}/voice_participants`), s => {
        const l = document.getElementById('participants-list'); l.innerHTML = "";
        s.forEach(p => { l.innerHTML += `<div style="font-size:10px;">‚Ä¢ ${p.val().name} (Live)</div>`; });
    });

    // --- CHAT & PAINT & OTHERS ---
    window.sendChat = () => {
        const i = document.getElementById('chat-input'); if(!i.value) return;
        push(ref(db, `${dbVer}/messages`), { uid:myUid, text:i.value, name:myData.username, pfp:myData.pfp, color:myData.color, isAdmin });
        i.value = "";
    };
    onValue(ref(db, `${dbVer}/messages`), s => {
        const c = document.getElementById('chat-content'); c.innerHTML = "";
        s.forEach(snap => {
            const m = snap.val();
            let name = m.isAdmin ? `<b class="hacker-name">${m.name}</b>` : `<b style="color:${m.color}">${m.name}</b>`;
            c.innerHTML += `<div class="chat-msg"><img src="${m.pfp}" class="avatar-sm"><div>${name}<br>${m.img ? `<img src="${m.img}" class="chat-img">` : m.text}</div></div>`;
        });
        c.scrollTop = c.scrollHeight;
    });

    window.saveProfile = () => {
        const u = document.getElementById('prof-user').value.trim(); if(!u) return;
        myData.username = u; myData.color = document.getElementById('prof-color').value;
        localStorage.setItem('khem_name', u); localStorage.setItem('khem_color', myData.color); localStorage.setItem('khem_pfp', myData.pfp);
        document.getElementById('login-lock').style.display = 'none'; window.closeWin('profile-win');
    };

    window.playCasino = () => {
        const bet = parseInt(document.getElementById('bet-amt').value);
        if(bet > myData.bal) return alert("Insufficient credits.");
        myData.bal -= bet;
        const emojis = ['üçí','üîî','üíé','7Ô∏è‚É£'];
        const r1 = emojis[Math.floor(Math.random()*4)], r2 = emojis[Math.floor(Math.random()*4)], r3 = emojis[Math.floor(Math.random()*4)];
        document.getElementById('casino-reel').innerText = `${r1} ${r2} ${r3}`;
        if(r1 === r2 && r2 === r3) { myData.bal += bet*10; alert("JACKPOT!"); }
        else if(r1 === r2 || r2 === r3) { myData.bal += bet*2; }
        document.getElementById('gamble-bal').innerText = myData.bal;
        localStorage.setItem('khem_bal', myData.bal);
    };

    window.toggleDarkMode = (v) => {
        document.body.classList.toggle('dark-mode-win', v);
        myData.dark = v; localStorage.setItem('khem_dark', v);
    };

    window.updateBg = (v) => {
        if(v==='cyber') document.body.style.background = "url('https://wallpaperaccess.com/full/151034.jpg')";
        else if(v==='xp') document.body.style.background = "url('https://i.imgur.com/Zk6ST2b.jpg')";
        else document.body.style.background = "#008080";
        myData.bg = v; localStorage.setItem('khem_bg', v);
    };

    window.authAdmin = () => { if(prompt("ROOT_KEY:") === PW) { isAdmin = true; window.openWin('admin-win'); } };
    
    // Minimal Minesweeper logic preserved
    window.initMines = () => {
        const g = document.getElementById('mine-grid'); g.innerHTML = "";
        for(let i=0; i<100; i++) {
            const c = document.createElement('div'); c.className = 'mine-cell cell-hidden';
            c.onclick = () => { c.className='cell-revealed'; c.innerText = Math.random() > 0.1 ? '1' : 'üí£'; };
            g.appendChild(c);
        }
    };
    window.initMines();

    setInterval(() => {
        const d = new Date(); document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
    }, 1000);
</script>
</body>
</html>
